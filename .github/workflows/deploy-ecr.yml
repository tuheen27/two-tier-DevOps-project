name: Deploy to AWS ECR

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy-to-ecr:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Pull latest image from Docker Hub
        run: docker pull tuheen27/two-tier-frontend-application:latest

      - name: Login to AWS ECR
        run: |
          aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin 744709874293.dkr.ecr.ap-south-1.amazonaws.com

      - name: Tag image for ECR
        run: docker tag tuheen27/two-tier-frontend-application:latest 744709874293.dkr.ecr.ap-south-1.amazonaws.com/dockerimage:latest

      - name: Push to AWS ECR
        run: |
          docker push 744709874293.dkr.ecr.ap-south-1.amazonaws.com/dockerimage:latest
          echo "✅ Successfully deployed to AWS ECR"

      - name: Verify ECR deployment
        run: |
          aws ecr describe-images --repository-name dockerimage --region ap-south-1 --image-ids imageTag=latest
          echo "✅ Image verified in ECR"

      - name: Cleanup
        if: always()
        run: |
          docker rmi tuheen27/two-tier-frontend-application:latest 744709874293.dkr.ecr.ap-south-1.amazonaws.com/dockerimage:latest || true
          docker logout
